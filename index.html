<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Prescription Refill Request | Cosentino's Food Stores</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f4f4f4;
    --surface: #ffffff;
    --text: #1a1a1a;
    --text-muted: #6b6b6b;
    --brand-dark: #32373c;
    --brand-darker: #23272b;
    --accent: #32373c;
    --accent-hover: #23272b;
    --accent-light: #eaedef;
    --border: #d5d5d5;
    --error: #cf2e2e;
    --error-bg: #fdf0ef;
    --success: #2e7d32;
    --success-bg: #eaf5eb;
    --radius: 8px;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
  }

  html { font-size: 16px; -webkit-text-size-adjust: 100%; }

  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0;
  }

  /* ---- Header ---- */
  .header {
    width: 100%;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .header-inner {
    width: 100%;
    max-width: 440px;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .header img {
    height: 36px;
    width: auto;
  }
  .header-text {
    border-left: 1px solid var(--border);
    padding-left: 14px;
  }
  .header-text h1 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.2;
  }
  .header-text p {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 400;
  }

  /* ---- Page title banner ---- */
  .banner {
    width: 100%;
    background: var(--brand-dark);
    color: white;
    padding: 20px 20px 24px;
    text-align: center;
  }
  .banner h2 {
    font-size: 1.2rem;
    font-weight: 600;
    letter-spacing: -0.01em;
    margin-bottom: 2px;
  }
  .banner p {
    font-size: 0.82rem;
    opacity: 0.8;
    font-weight: 400;
  }

  /* ---- Main card ---- */
  .card {
    width: 100%;
    max-width: 440px;
    background: var(--surface);
    margin: -10px 16px 24px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    padding: 28px 24px 32px;
    position: relative;
    z-index: 1;
  }

  /* ---- Form fields ---- */
  .field { margin-bottom: 22px; }
  .field:last-of-type { margin-bottom: 28px; }

  label {
    display: block;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
    letter-spacing: 0.01em;
  }
  label .optional {
    font-weight: 400;
    color: var(--text-muted);
    font-size: 0.78rem;
  }

  input, select {
    width: 100%;
    padding: 13px 14px;
    font-size: 1rem;
    font-family: inherit;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    color: var(--text);
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
    appearance: none;
    -webkit-appearance: none;
  }
  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-light);
  }
  input::placeholder { color: #b0b0a8; }

  /* Rx number helper text */
  .field-hint {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 5px;
  }

  /* Custom select arrow */
  .select-wrap {
    position: relative;
  }
  .select-wrap::after {
    content: '';
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    width: 0; height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 6px solid var(--text-muted);
    pointer-events: none;
  }
  select { padding-right: 38px; cursor: pointer; }

  /* Rx number field - larger */
  .rx-input {
    font-size: 1.25rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-align: center;
    padding: 16px 14px;
  }

  /* ---- Submit ---- */
  .submit-btn {
    width: 100%;
    padding: 15px;
    font-size: 1rem;
    font-weight: 600;
    font-family: inherit;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.1s ease;
    letter-spacing: 0.01em;
  }
  .submit-btn:hover { background: var(--accent-hover); }
  .submit-btn:active { transform: scale(0.985); }
  .submit-btn:disabled {
    background: #9ca3a9;
    cursor: not-allowed;
    transform: none;
  }

  /* ---- Messages ---- */
  .message {
    margin-top: 20px;
    padding: 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    line-height: 1.5;
    display: none;
  }
  .message.error {
    background: var(--error-bg);
    color: var(--error);
    border: 1px solid #e8c4c0;
    display: block;
  }
  .message.success {
    background: var(--success-bg);
    color: var(--success);
    border: 1px solid #b8d8c4;
    display: block;
  }
  .message strong { font-weight: 600; }

  /* ---- Footer ---- */
  .footer {
    text-align: center;
    padding: 0 20px 32px;
    font-size: 0.75rem;
    color: var(--text-muted);
    line-height: 1.7;
    max-width: 440px;
  }
  .footer p { margin-bottom: 4px; }
  .footer a {
    color: var(--text-muted);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .footer a:hover { color: var(--text); }
  .footer .copyright {
    margin-top: 16px;
    font-size: 0.7rem;
    opacity: 0.7;
  }

  /* ---- Loading spinner ---- */
  .spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ---- Success state ---- */
  .success-view {
    display: none;
    text-align: center;
    padding: 12px 0;
  }
  .success-view .checkmark {
    width: 64px; height: 64px;
    background: var(--success-bg);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
  }
  .success-view .checkmark svg {
    width: 32px; height: 32px;
    stroke: var(--success);
    stroke-width: 2.5;
    fill: none;
  }
  .success-view h2 {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
  }
  .success-view p {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 6px;
  }
  .success-view .store-phone {
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent);
    text-decoration: none;
  }
  .success-view .store-phone:hover { text-decoration: underline; }
  .new-request-btn {
    margin-top: 24px;
    padding: 12px 28px;
    font-size: 0.9rem;
    font-weight: 500;
    font-family: inherit;
    background: transparent;
    color: var(--accent);
    border: 1.5px solid var(--accent);
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s ease, color 0.15s ease;
  }
  .new-request-btn:hover {
    background: var(--accent);
    color: white;
  }

  /* ---- Choice view (Layout A) ---- */
  .choice-view {
    text-align: center;
    padding: 8px 0;
  }
  .choice-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 24px;
  }
  .choice-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 18px;
    font-size: 1.05rem;
    font-weight: 600;
    font-family: inherit;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.1s ease;
    letter-spacing: 0.01em;
    border: none;
  }
  .choice-btn:active { transform: scale(0.985); }
  .choice-btn + .choice-btn { margin-top: 12px; }
  .choice-btn-primary {
    background: var(--accent);
    color: white;
  }
  .choice-btn-primary:hover { background: var(--accent-hover); }
  .choice-btn-secondary {
    background: transparent;
    color: var(--accent);
    border: 1.5px solid var(--accent);
  }
  .choice-btn-secondary:hover {
    background: var(--accent);
    color: white;
  }
  .choice-icon {
    width: 22px;
    height: 22px;
    flex-shrink: 0;
  }

  /* ---- Scan header button (Layout B - inside existing form) ---- */
  .scan-header-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 14px;
    font-size: 0.95rem;
    font-weight: 600;
    font-family: inherit;
    background: var(--success-bg);
    color: var(--success);
    border: 1.5px solid #b8d8c4;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.1s ease;
    margin-bottom: 24px;
  }
  .scan-header-btn:active { transform: scale(0.985); }
  .scan-header-btn:hover { background: #d9eedc; }
  .scan-header-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  /* ---- Scanner view ---- */
  .scanner-view {
    display: none;
    text-align: center;
  }
  .scanner-instruction {
    font-size: 0.88rem;
    color: var(--text-muted);
    margin-bottom: 16px;
    line-height: 1.4;
  }
  .scanner-container {
    position: relative;
    width: 100%;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 16px;
    background: #000;
  }
  #scannerVideo {
    display: block;
    width: 100%;
    min-height: 240px;
    max-height: 50vh;
    object-fit: cover;
  }
  .scanner-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  .guide-box {
    position: relative;
    width: 80%;
    height: 90px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.45);
    border-radius: 4px;
  }
  .guide-corner {
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: #fff;
    border-style: solid;
  }
  .guide-corner.tl { top: -2px; left: -2px; border-width: 3px 0 0 3px; }
  .guide-corner.tr { top: -2px; right: -2px; border-width: 3px 3px 0 0; }
  .guide-corner.bl { bottom: -2px; left: -2px; border-width: 0 0 3px 3px; }
  .guide-corner.br { bottom: -2px; right: -2px; border-width: 0 3px 3px 0; }
  .scan-line {
    position: absolute;
    left: 8px;
    right: 8px;
    height: 2px;
    background: linear-gradient(90deg, transparent, #ff4444, transparent);
    animation: scanmove 2s ease-in-out infinite;
  }
  @keyframes scanmove {
    0%, 100% { top: 15%; opacity: 0.6; }
    50% { top: 85%; opacity: 1; }
  }

  /* ---- Scanned form ---- */
  .scanned-form { display: none; }
  .scan-result-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: var(--success-bg);
    color: var(--success);
    border: 1px solid #b8d8c4;
    border-radius: 6px;
    padding: 10px 16px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 24px;
  }
  .scan-check-icon {
    width: 18px;
    height: 18px;
    stroke: var(--success);
    stroke-width: 2.5;
    fill: none;
  }
  .readonly-field {
    background: var(--accent-light) !important;
    color: var(--text);
    cursor: default;
    border-color: var(--accent-light) !important;
  }
  .readonly-field:focus {
    box-shadow: none !important;
    border-color: var(--accent-light) !important;
  }
  .back-link {
    display: block;
    width: 100%;
    margin-top: 16px;
    padding: 10px;
    font-size: 0.85rem;
    font-weight: 500;
    font-family: inherit;
    background: transparent;
    color: var(--text-muted);
    border: none;
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 2px;
    text-align: center;
  }
  .back-link:hover { color: var(--text); }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <img src="https://cosentinos.com/wp-content/uploads/Cosentinos-Food-Stores.svg"
         alt="Cosentino's Food Stores">
    <div class="header-text">
      <h1>Pharmacy</h1>
      <p>Prescription Refill</p>
    </div>
  </div>
</div>

<div class="banner">
  <h2>Request a Prescription Refill</h2>
  <p>Submit your Rx number and we'll have it ready for pickup</p>
</div>

<div class="card">
  <!-- Choice view (Layout A start) -->
  <div id="choiceView" class="choice-view" style="display:none;">
    <p class="choice-subtitle">How would you like to submit your refill?</p>
    <button type="button" class="choice-btn choice-btn-primary" id="choiceScanBtn">
      <svg class="choice-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7V5a2 2 0 012-2h2"/>
        <path d="M17 3h2a2 2 0 012 2v2"/>
        <path d="M21 17v2a2 2 0 01-2 2h-2"/>
        <path d="M7 21H5a2 2 0 01-2-2v-2"/>
        <line x1="7" y1="12" x2="17" y2="12"/>
      </svg>
      Scan Barcode
    </button>
    <button type="button" class="choice-btn choice-btn-secondary" id="choiceManualBtn">
      Enter Manually
    </button>
  </div>

  <!-- Scanner view -->
  <div id="scannerView" class="scanner-view">
    <p class="scanner-instruction">Point your camera at the barcode on your prescription label</p>
    <div class="scanner-container">
      <video id="scannerVideo" playsinline autoplay muted></video>
      <div class="scanner-overlay">
        <div class="guide-box">
          <div class="guide-corner tl"></div>
          <div class="guide-corner tr"></div>
          <div class="guide-corner bl"></div>
          <div class="guide-corner br"></div>
          <div class="scan-line"></div>
        </div>
      </div>
    </div>
    <div class="message" id="scanError"></div>
    <button type="button" class="choice-btn choice-btn-secondary" id="cancelScanBtn">Cancel</button>
  </div>

  <!-- Scanned form (post-scan confirmation) -->
  <form id="scannedForm" class="scanned-form">
    <div class="scan-result-badge">
      <svg viewBox="0 0 24 24" class="scan-check-icon"><polyline points="20 6 9 17 4 12"></polyline></svg>
      Barcode Scanned
    </div>

    <div class="field">
      <label>Pharmacy Location</label>
      <input type="text" id="scannedStore" class="readonly-field" readonly tabindex="-1">
      <input type="hidden" id="scannedStoreId">
    </div>

    <div class="field">
      <label>Prescription Number (Rx#)</label>
      <input type="text" id="scannedRx" class="rx-input readonly-field" readonly tabindex="-1">
    </div>

    <div class="field">
      <label for="scannedName">First Name <span class="optional">(optional)</span></label>
      <input type="text" id="scannedName"
             placeholder="Helps staff locate your order"
             maxlength="50" autocomplete="given-name">
    </div>

    <button type="submit" class="submit-btn" id="scannedSubmitBtn">
      Submit Refill Request
    </button>

    <div class="message" id="scannedErrorMsg"></div>
    <button type="button" class="back-link" id="rescanBtn">Scan a different barcode</button>
  </form>

  <!-- Manual form view -->
  <form id="refillForm" style="display:none;">
    <!-- Scan button for Layout B (hidden in Layout A) -->
    <button type="button" class="scan-header-btn" id="formScanBtn" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7V5a2 2 0 012-2h2"/>
        <path d="M17 3h2a2 2 0 012 2v2"/>
        <path d="M21 17v2a2 2 0 01-2 2h-2"/>
        <path d="M7 21H5a2 2 0 01-2-2v-2"/>
        <line x1="7" y1="12" x2="17" y2="12"/>
      </svg>
      Scan Barcode Instead
    </button>

    <div class="field">
      <label for="storeSelect">Pharmacy Location</label>
      <div class="select-wrap">
        <select id="storeSelect" required>
          <option value="" disabled selected>Select your pharmacy...</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label for="rxNumber">Prescription Number (Rx#)</label>
      <input type="text" id="rxNumber" class="rx-input"
             inputmode="numeric" pattern="[2468]\d{6}"
             placeholder="e.g. 6876386" required
             minlength="7" maxlength="7"
             autocomplete="off">
      <div class="field-hint">7-digit number found on your prescription label</div>
    </div>

    <div class="field">
      <label for="patientName">First Name <span class="optional">(optional)</span></label>
      <input type="text" id="patientName"
             placeholder="Helps staff locate your order"
             maxlength="50" autocomplete="given-name">
    </div>

    <button type="submit" class="submit-btn" id="submitBtn">
      Submit Refill Request
    </button>

    <div class="message" id="errorMsg"></div>
    <button type="button" class="back-link" id="backToChoiceBtn" style="display:none;">Back</button>
  </form>

  <!-- Success view -->
  <div class="success-view" id="successView">
    <div class="checkmark">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
    </div>
    <h2>Request Submitted</h2>
    <p id="successText"></p>
    <p>Questions? Call your pharmacy:</p>
    <a href="#" class="store-phone" id="storePhone"></a>
    <br>
    <button class="new-request-btn" onclick="resetForm()">Submit Another Refill</button>
  </div>
</div>

<div class="footer">
  <p>Your prescription number is on your prescription label.</p>
  <p>This form does not access medical or personal health information.</p>
  <p>Questions? <a href="mailto:comments@cosentinos.com">comments@cosentinos.com</a></p>
  <p class="copyright">&copy; 2026 Cosentino's Food Stores. All rights reserved.</p>
</div>

<script>
  // ---- Layout detection ----
  const urlParams = new URLSearchParams(window.location.search);
  const layout = urlParams.get('layout') || 'choice';  // 'choice' (A) or 'form' (B)

  // ---- Element references (existing) ----
  const form = document.getElementById('refillForm');
  const storeSelect = document.getElementById('storeSelect');
  const rxInput = document.getElementById('rxNumber');
  const nameInput = document.getElementById('patientName');
  const submitBtn = document.getElementById('submitBtn');
  const errorMsg = document.getElementById('errorMsg');
  const successView = document.getElementById('successView');
  const successText = document.getElementById('successText');
  const storePhone = document.getElementById('storePhone');

  // ---- Element references (new) ----
  const choiceView = document.getElementById('choiceView');
  const scannerView = document.getElementById('scannerView');
  const scannedForm = document.getElementById('scannedForm');
  const choiceScanBtn = document.getElementById('choiceScanBtn');
  const choiceManualBtn = document.getElementById('choiceManualBtn');
  const formScanBtn = document.getElementById('formScanBtn');
  const cancelScanBtn = document.getElementById('cancelScanBtn');
  const scanError = document.getElementById('scanError');
  const scannedStoreInput = document.getElementById('scannedStore');
  const scannedStoreIdInput = document.getElementById('scannedStoreId');
  const scannedRxInput = document.getElementById('scannedRx');
  const scannedNameInput = document.getElementById('scannedName');
  const scannedSubmitBtn = document.getElementById('scannedSubmitBtn');
  const scannedErrorMsg = document.getElementById('scannedErrorMsg');
  const rescanBtn = document.getElementById('rescanBtn');
  const backToChoiceBtn = document.getElementById('backToChoiceBtn');

  const scannerVideo = document.getElementById('scannerVideo');

  // ---- State ----
  let storesData = [];
  let barcodeDetector = null;
  let scannerStream = null;
  let scanning = false;
  let scanAnimFrame = null;
  let lastScanTime = 0;

  const API_BASE = window.location.origin;

  // ---- View switching ----
  function getStartView() {
    return layout === 'form' ? 'manual' : 'choice';
  }

  function showView(viewName) {
    choiceView.style.display = 'none';
    scannerView.style.display = 'none';
    scannedForm.style.display = 'none';
    form.style.display = 'none';
    successView.style.display = 'none';

    switch (viewName) {
      case 'choice':  choiceView.style.display = 'block'; break;
      case 'scanner': scannerView.style.display = 'block'; break;
      case 'scanned': scannedForm.style.display = 'block'; break;
      case 'manual':  form.style.display = 'block'; break;
      case 'success': successView.style.display = 'block'; break;
    }
  }

  // ---- Layout-specific setup ----
  function initLayout() {
    if (layout === 'form') {
      // Layout B: show form with scan button at top
      formScanBtn.style.display = 'flex';
      showView('manual');
    } else {
      // Layout A: show choice view; "Back" link visible in manual form
      backToChoiceBtn.style.display = 'block';
      showView('choice');
    }
  }

  // ---- Store loading ----
  async function loadStores() {
    try {
      const resp = await fetch(`${API_BASE}/api/stores`);
      const stores = await resp.json();
      storesData = stores;

      const grouped = {};
      stores.forEach(s => {
        if (!grouped[s.state]) grouped[s.state] = [];
        grouped[s.state].push(s);
      });

      Object.keys(grouped).sort().forEach(state => {
        const group = document.createElement('optgroup');
        group.label = state === 'MO' ? 'Missouri' : state === 'KS' ? 'Kansas' : state;
        grouped[state].forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.label;
          group.appendChild(opt);
        });
        storeSelect.appendChild(group);
      });
    } catch (e) {
      showError('Unable to load pharmacy locations. Please try again later.');
    }
  }

  function findStoreById(storeId) {
    return storesData.find(s => s.id === storeId) || null;
  }

  // ---- Barcode parsing ----
  function parseBarcode(rawText) {
    const text = rawText.replace(/\s/g, '');

    if (!/^\d{12}$/.test(text)) {
      return { error: 'Invalid barcode format. Expected 12 digits.' };
    }

    const rxNumber = text.substring(0, 7);
    const fillNumber = text.substring(7, 9);
    const storeNumber = text.substring(9, 12);

    if (!'2468'.includes(rxNumber[0])) {
      return { error: 'Invalid prescription number in barcode.' };
    }

    return { rxNumber, fillNumber, storeNumber, error: null };
  }

  // ---- Scanner lifecycle ----
  const SCAN_INTERVAL = 100; // ~10fps throttle

  async function startScanner() {
    showView('scanner');
    clearScanError();

    // Stop any existing scanner session
    await stopScanner();

    if (!('BarcodeDetector' in window)) {
      showScanError('Barcode scanning is not supported on this browser. Please enter your prescription manually.');
      return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      showScanError('Camera access is not available. Please enter your prescription manually.');
      return;
    }

    try {
      // Create detector on first use and verify code_128 support
      if (!barcodeDetector) {
        const formats = await BarcodeDetector.getSupportedFormats();
        if (!formats.includes('code_128')) {
          showScanError('Barcode scanning is not supported on this browser. Please enter your prescription manually.');
          return;
        }
        barcodeDetector = new BarcodeDetector({ formats: ['code_128'] });
      }

      scannerStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 },
        },
        audio: false,
      });

      scannerVideo.srcObject = scannerStream;
      await scannerVideo.play();

      scanning = true;
      lastScanTime = 0;
      scanAnimFrame = requestAnimationFrame(scanLoop);
    } catch (err) {
      handleCameraError(err);
    }
  }

  function scanLoop(timestamp) {
    if (!scanning) return;

    if (timestamp - lastScanTime < SCAN_INTERVAL) {
      scanAnimFrame = requestAnimationFrame(scanLoop);
      return;
    }
    lastScanTime = timestamp;

    if (scannerVideo.readyState < scannerVideo.HAVE_ENOUGH_DATA) {
      scanAnimFrame = requestAnimationFrame(scanLoop);
      return;
    }

    barcodeDetector.detect(scannerVideo).then(barcodes => {
      if (!scanning) return;
      if (barcodes.length > 0) {
        onScanSuccess(barcodes[0].rawValue);
      } else {
        scanAnimFrame = requestAnimationFrame(scanLoop);
      }
    }).catch(() => {
      if (scanning) scanAnimFrame = requestAnimationFrame(scanLoop);
    });
  }

  function pauseScanning() {
    scanning = false;
    if (scanAnimFrame) { cancelAnimationFrame(scanAnimFrame); scanAnimFrame = null; }
  }

  function resumeScanning() {
    if (!scannerStream) return;
    scanning = true;
    lastScanTime = 0;
    scanAnimFrame = requestAnimationFrame(scanLoop);
  }

  async function stopScanner() {
    scanning = false;
    if (scanAnimFrame) { cancelAnimationFrame(scanAnimFrame); scanAnimFrame = null; }
    if (scannerStream) {
      scannerStream.getTracks().forEach(t => t.stop());
      scannerStream = null;
    }
    scannerVideo.srcObject = null;
  }

  function onScanSuccess(decodedText) {
    const parsed = parseBarcode(decodedText);

    if (parsed.error) {
      // Bad barcode format: pause scanning, show error, then resume
      pauseScanning();
      showScanError(parsed.error + ' Please try again.');
      setTimeout(() => { clearScanError(); resumeScanning(); }, 2000);
      return;
    }

    // Valid barcode
    if (navigator.vibrate) navigator.vibrate(100);
    stopScanner();

    const store = findStoreById(parsed.storeNumber);
    if (!store) {
      showScanError(`Store #${parsed.storeNumber} was not recognized. Please enter your refill manually.`);
      setTimeout(() => { clearScanError(); showView(getStartView()); }, 3000);
      return;
    }

    scannedStoreInput.value = store.label;
    scannedStoreIdInput.value = store.id;
    scannedRxInput.value = parsed.rxNumber;
    scannedNameInput.value = '';

    showView('scanned');
  }

  function handleCameraError(err) {
    const msg = err.toString().toLowerCase();

    if (msg.includes('permission') || msg.includes('notallowed')) {
      showScanError('Camera access was denied. Please allow camera permission in your browser settings, or enter your refill manually.');
    } else if (msg.includes('notfound') || msg.includes('no video')) {
      showScanError('No camera found on this device. Please enter your refill manually.');
    } else if (msg.includes('notreadable') || msg.includes('could not start')) {
      showScanError('Camera is in use by another app. Please close it and try again.');
    } else {
      showScanError('Unable to start the camera. Please enter your refill manually.');
    }
  }

  // ---- Rx input filter ----
  rxInput.addEventListener('input', () => {
    rxInput.value = rxInput.value.replace(/\D/g, '').slice(0, 7);
  });

  // ---- Manual form submission (existing) ----
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();

    const rx = rxInput.value.trim();
    const store = storeSelect.value;
    const name = nameInput.value.trim();

    if (!store) { showError('Please select your pharmacy location.'); return; }
    if (!rx || rx.length !== 7) {
      showError('Prescription number must be exactly 7 digits.');
      return;
    }
    if (!'2468'.includes(rx[0])) {
      showError('Prescription number must start with 2, 4, 6, or 8.');
      return;
    }

    setLoading(true);
    try {
      const resp = await fetch(`${API_BASE}/api/refill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rx_number: rx, store_id: store, patient_name: name }),
      });

      const data = await resp.json();

      if (!resp.ok) {
        const detail = data.detail;
        if (Array.isArray(detail)) {
          showError(detail.map(d => d.msg).join('. '));
        } else if (typeof detail === 'string') {
          showError(detail);
        } else {
          showError('Something went wrong. Please try again.');
        }
        return;
      }

      showSuccess(data);
    } catch (e) {
      showError('Unable to submit. Please check your connection and try again.');
    } finally {
      setLoading(false);
    }
  });

  // ---- Scanned form submission ----
  scannedForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearScannedError();

    const rx = scannedRxInput.value.trim();
    const storeId = scannedStoreIdInput.value;
    const name = scannedNameInput.value.trim();

    if (!storeId) { showScannedError('Store not identified. Please scan again.'); return; }
    if (!rx || rx.length !== 7) { showScannedError('Invalid Rx number. Please scan again.'); return; }

    setScannedLoading(true);
    try {
      const resp = await fetch(`${API_BASE}/api/refill`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rx_number: rx, store_id: storeId, patient_name: name }),
      });

      const data = await resp.json();

      if (!resp.ok) {
        const detail = data.detail;
        if (Array.isArray(detail)) {
          showScannedError(detail.map(d => d.msg).join('. '));
        } else if (typeof detail === 'string') {
          showScannedError(detail);
        } else {
          showScannedError('Something went wrong. Please try again.');
        }
        return;
      }

      showSuccess(data);
    } catch (e) {
      showScannedError('Unable to submit. Please check your connection and try again.');
    } finally {
      setScannedLoading(false);
    }
  });

  // ---- Shared success display ----
  function showSuccess(data) {
    successText.textContent = data.message;
    if (data.store_phone) {
      storePhone.textContent = data.store_phone;
      storePhone.href = `tel:${data.store_phone.replace(/\D/g, '')}`;
      storePhone.style.display = '';
    } else {
      storePhone.style.display = 'none';
    }
    showView('success');
  }

  // ---- UI helpers ----
  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.className = 'message error';
  }
  function clearError() {
    errorMsg.textContent = '';
    errorMsg.className = 'message';
  }
  function setLoading(loading) {
    submitBtn.disabled = loading;
    submitBtn.innerHTML = loading
      ? '<span class="spinner"></span>Submitting...'
      : 'Submit Refill Request';
  }

  function showScanError(msg) {
    scanError.textContent = msg;
    scanError.className = 'message error';
  }
  function clearScanError() {
    scanError.textContent = '';
    scanError.className = 'message';
  }

  function showScannedError(msg) {
    scannedErrorMsg.textContent = msg;
    scannedErrorMsg.className = 'message error';
  }
  function clearScannedError() {
    scannedErrorMsg.textContent = '';
    scannedErrorMsg.className = 'message';
  }
  function setScannedLoading(loading) {
    scannedSubmitBtn.disabled = loading;
    scannedSubmitBtn.innerHTML = loading
      ? '<span class="spinner"></span>Submitting...'
      : 'Submit Refill Request';
  }

  function resetForm() {
    form.reset();
    scannedForm.reset();
    clearError();
    clearScanError();
    clearScannedError();
    showView(getStartView());
  }

  // ---- Event listeners ----
  choiceScanBtn.addEventListener('click', () => startScanner());
  choiceManualBtn.addEventListener('click', () => showView('manual'));
  formScanBtn.addEventListener('click', () => startScanner());

  cancelScanBtn.addEventListener('click', async () => {
    await stopScanner();
    showView(getStartView());
  });

  rescanBtn.addEventListener('click', () => {
    scannedForm.reset();
    clearScannedError();
    startScanner();
  });

  backToChoiceBtn.addEventListener('click', () => {
    form.reset();
    clearError();
    showView('choice');
  });

  // ---- Init ----
  initLayout();
  loadStores();
</script>
</body>
</html>
